# WHALE - Default server: proxy to WordPress backend com proteções de segurança
server {
    listen 80 default_server;
    server_name _;

    # Bloqueio de User-Agents suspeitos (curl, wget, scrapers, bots)
    if ($http_user_agent ~* (curl|wget|python|scrapy|bot|spider|masscan|nmap)) {
        return 403;
    }

    # Blacklist de IPs específicos (adicione IPs ou ranges conforme necessário)
    # deny 192.168.1.100;
    # deny 203.0.113.0/24;

    location / {
        # Rate limiting: máximo 10 req/s, burst de 20, nodelay para resposta imediata
        limit_req zone=one burst=20 nodelay;

        proxy_pass http://wordpress_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # Proteção contra timeout e conexões lentas
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }
}

# HTTPS (uncomment and adjust after obtaining certificates)
# server {
#     listen 443 ssl default_server;
#     server_name _;
#     ssl_certificate     /etc/nginx/ssl/live/default/fullchain.pem;
#     ssl_certificate_key /etc/nginx/ssl/live/default/privkey.pem;
#     location / {
#         proxy_pass http://wordpress_backend;
#         proxy_set_header Host $host;
#         proxy_set_header X-Real-IP $remote_addr;
#         proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
#         proxy_set_header X-Forwarded-Proto https;
#     }
# }
